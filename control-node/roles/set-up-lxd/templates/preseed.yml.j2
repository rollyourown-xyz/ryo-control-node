# SPDX-FileCopyrightText: 2022 Wilfred Nicoll <xyzroller@rollyourown.xyz>
# SPDX-License-Identifier: GPL-3.0-or-later

#-------------------------------------------------------------------------------------------
# WARNING: Never push this file, with secrets, to a repository nor publish in any other way!
# DO NOT DELETE THIS FILE WHILE ANY HOST IS STILL IN USE
#
# This file is auto-generated by the control node setup playbook
#-------------------------------------------------------------------------------------------
# Daemon settings
config:
  core.https_address: '[::]'
  images.auto_update_interval: 6

# Storage pools
storage_pools:
- name: lxd
  description: ""
  driver: zfs
  config:     
    size: 10GB
    source: /var/snap/lxd/common/lxd/disks/lxd.img
    zfs.pool_name: lxd

# Network devices
networks:
- name: lxdbr0
  description: ""
  type: bridge
  managed: true
  config:
    ipv4.address: '172.16.10.1/24'
    ipv4.dhcp.expiry: 5m
    ipv4.nat: "true"
    ipv6.address: none
    dns.mode: managed
    dns.domain: lxd

# Profiles
profiles:
- name: build
  description: LXD profile for building images
  devices:
    eth0:
      name: eth0
      network: lxdbr0
      type: nic
    root:
      path: /
      pool: lxd
      type: disk
- name: microk8s
  description: "microk8s container image build profile"
  devices:
    eth0:
      name: eth0
      network: lxdbr0
      type: nic
    root:
      path: /
      pool: lxd
      type: disk
    aadisable:
      path: /sys/module/nf_conntrack/parameters/hashsize
      source: /sys/module/nf_conntrack/parameters/hashsize
      type: disk
    aadisable2:
      path: /dev/zfs
      source: /dev/zfs
      type: disk
    aadisable3:
      path: /dev/kmsg
      source: /dev/kmsg
      type: unix-char
    aadisable4:
      path: /sys/fs/bpf
      source: /sys/fs/bpf
      type: disk
    aadisable5:
      path: /proc/sys/net/netfilter/nf_conntrack_max
      source: /proc/sys/net/netfilter/nf_conntrack_max
      type: disk
  config:
    boot.autostart: "true"
    linux.kernel_modules: ip_vs,ip_vs_rr,ip_vs_wrr,ip_vs_sh,ip_tables,ip6_tables,netlink_diag,nf_nat,overlay,br_netfilter
    raw.lxc: |
      lxc.apparmor.profile=unconfined
      lxc.mount.auto=proc:rw sys:rw cgroup:rw
      lxc.cgroup.devices.allow=a
      lxc.cap.drop=
    security.nesting: "true"
    security.privileged: "true"
